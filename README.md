# Desarrollando y desplegando un modelo de reconocimiento de d√≠gitos con Streamlit

En este art√≠culo veremos c√≥mo crear y desplegar una sencilla aplicaci√≥n de reconocimiento de d√≠gitos con **Streamlit**.

## Un poco sobre mi.
Mi nombre es Sergio Tejedor y soy un ingeniero industrial apasionado por el **Machine Learning**, la programaci√≥n en **Python** y el desarrollo de aplicaciones. Actualmente soy director t√©cnico de un grupo empresarial especializado en la laminaci√≥n de perfiles en fr√≠o y fabricaci√≥n de invernaderos industriales. Hace ya algo m√°s de un a√±o decid√≠ dar el salto y ponerme a estudiar por mi cuenta programaci√≥n. 

Escog√≠ **Python** como lenguaje por su suave curva de aprendizaje y por ser uno de los lenguajes m√°s utilizados en la ciencia de datos y el **Machine Learning**. Al profundizar y descubrir la gran flexibilidad de este lenguaje de programaci√≥n, de entre todas sus posibilidades, decid√≠ centrarme en el campo del **Machine Learning** ya que es aquel que m√°s sinergias pod√≠a tener con mi formaci√≥n y profesi√≥n.

## ¬ø Por qu√© Streamlit ?
Enseguida empec√© a desarrollar aplicaciones y querer compartirlas con amigos. No tard√© en descubrir el framework para Python [**Streamlit**](https://streamlit.io/). Siempre hab√≠a encontrado dificultades a la hora de desplegar aplicaciones (y las sigo encontrando) y es precisamente este uno de los puntos fuertes de esta librer√≠a. **Streamlit** permite crear y desplegar aplicaciones web din√°micas en las que poder compartir y visualizar tus proyectos de ciencia de datos utilizando √∫nicamente Python y sin necesidad de conocimiento profundo de tecnolog√≠as web. De forma r√°pida y muy sencilla. Mediante los widgets disponibles, se pueden cargar *archivos*, *visualizar gr√°ficos*, *dataframes* y muchas cosas m√°s.
Tiene una comunidad creciente de usuarios y desarrolladores y una buena [documentaci√≥n](https://docs.streamlit.io/library/api-reference) con ejemplos ilustrativos.

## Descripci√≥n de la app.
Las posibilidades con **Streamlit** son casi ilimitadas pero hoy abordaremos el desarrollo de una aplicaci√≥n de reconocimiento de d√≠gitos. La aplicaci√≥n est√° disponible [aqu√≠](https://tutorial-kopuru.streamlit.app/).
![Alt text](img/aplicacion_view.JPG)
La aplicaci√≥n ofrece adem√°s la posibilidad de evaluar las predicciones del modelo y mostrar una serie de estad√≠sticas.

En definitiva, creo que es un buen ejemplo de muchas de las posibilidades que ofrece **Streamlit** a la hora de dise√±ar una aplicaci√≥n web.

A nivel de estructura, la aplicaci√≥n cuenta con 2 p√°ginas:

La p√°gina principal, **Aplicaci√≥n**, est√° organizada en **5 pesta√±as**:

### Cargar imagen
![Alt text](img/pesta%C3%B1a_cargar_imagen.JPG)
- En esta pesta√±a es donde el usuario podr√° cargar su d√≠gito.

### Ver d√≠gito
![Alt text](img/pesta%C3%B1a_ver_digito.JPG)
- Aqu√≠ se mostrar√° una representaci√≥n de la imagen del usuario.

### Predecir
![Alt text](img/pesta%C3%B1a_predecir.JPG)
- Mediante un bot√≥n se lanza la predicci√≥n del modelo que se mostrar√° m√°s abajo.

### Evaluar
![Alt text](img/pesta%C3%B1a_evaluar.JPG)
- En esta pesta√±a se eval√∫a el modelo contrast√°ndolo con el d√≠gito real que se pretend√≠a dibujar y se da la posibilidad de guardar dicha evaluaci√≥n.

### Ver estad√≠sticas
![Alt text](img/pesta%C3%B1a_estadisticas.JPG)
- Con todas las evaluaciones guardadas se realizan algunas gr√°ficas estad√≠sticas.

La √∫nica p√°gina secundaria, **Modelo**, tiene detalles del modelo entrenado. Al acceder a ella se muestran en forma de *'stream'* las capas y par√°metros del modelo.

## Desarrollo de la app.
Crea un nuevo proyecto en tu editor de c√≥digo favorito. Personalmente uso [**Visual Studio Code**](https://code.visualstudio.com/) para desarrollar mis aplicaciones ya que lo encuentro f√°cil de usar y muy personalizable. La gran cantidad de extensiones disponibles facilitan mucho el desarrollo del c√≥digo.

Crearemos el script **Aplicacion.py** que recoger√° el c√≥digo de la p√°gina principal y la carpeta **pages** con el archivo **1_Modelo.py** en su interior. Las aplicaciones multip√°gina en streamlit se configuran de este modo; una p√°gina inicial o principal en la ruta raiz del proyecto y todas las p√°ginas secundarias deber√°n ir dentro de una carpeta **pages**. Es recomendable nombrar los scripts de las p√°ginas secundarias con los prefijos 1_xx, 2_xx, 3_xx etc para que streamlit pueda reconocerlos correctamente.

El siguiente paso es configurar un entorno virtual e instalar las dependencias necesarias. Para proyectos en los que utilizo alg√∫n tipo de modelo de deep learning con tensorflow tengo un entorno virtual llamado **tensorflow** creado con **conda** con todos los paquetes necesarios. Puedes crear el entorno virtual usando Python en su versi√≥n 3.9 con el siguiente comando en la terminal:
 ```sh
$ conda create --name tensorflow python=3.9
```
No olvides activar el entorno virtual
```sh
$ conda activate tensorflow
```
Para este proyecto concretamente instalaremos las siguientes dependencias:
```sh
$ pip install streamlit tensorflow numpy pandas Pillow matplotlib
```
Para realizar el despliegue de la aplicaci√≥n una vez hayamos terminado su desarrollo, ser√° necesario tener una cuenta en [**GitHub**](https://github.com/) y aunque pueda hacerse al final, suele ser aconsejable iniciar **git** en el proyecto e ir guardando los avances de la aplicaci√≥n en tu repositorio de GitHub. Ya sabes, por lo que pueda pasar.

**Streamlit** permite configurar algunos temas para toda la aplicaci√≥n. Esto se realiza con un archivo **config.toml** que debe insertarse en una carpeta **.streamlit** en la rama principal de tu proyecto.

Algunas [personalizaciones](https://docs.streamlit.io/library/advanced-features/theming) posibles son: el color del texto, los colores de fondo, colores de acento y tipo de letra.
```js
[theme]
# backgroundColor="#EFF6EE"
# secondaryBackgroundColor="#aab0bd"

primaryColor="#f2a416"
base="dark" # o "light"
textColor="#EEEDEB"
font="sans serif"
```
Hasta ahora, esta es la jerarqu√≠a de archivos de nuestro proyecto:
```sh
Carpeta Principal del proyecto
‚îú‚îÄ‚îÄ .streamlit
‚îÇ   ‚îî‚îÄ‚îÄ config.toml
‚îú‚îÄ‚îÄ .git
‚îú‚îÄ‚îÄ pages
‚îÇ   ‚îî‚îÄ‚îÄ 1_Modelo.py
‚îî‚îÄ‚îÄ Aplicacion.py
```
### Script principal. Aplicacion.py
Es hora de empezar a picar el c√≥digo de nuestro archivo principal: **Aplicacion.py**. Para ver el c√≥digo completo de la aplicaci√≥n comentado, puedes echar un vistazo a mi [repositorio](https://github.com/sertemo/tutorial-kopuru-streamlit) en github.

Casi siempre estructuro el script en varios bloques ([PEP8](https://peps.python.org/pep-0008/) para buenas pr√°cticas en Python):
1. Importaciones, ordenadas de la siguiente manera:
    1. Librer√≠as internas
    2. Librer√≠as de terceros (*pip install*)
    3. Librer√≠as o m√≥dulos de la aplicaci√≥n
2. Constantes usadas en el script
3. Funciones auxiliares usadas en el script
4. Funci√≥n principal **main**
5. Entry point de la app con:
    ```py
    if __name__ == '__main__':
        main()
    ```

Para poder acceder a todas las funcionalidades necesitamos importar **streamlit** con el alias **st** (esto es por convenci√≥n). Aprovechamos tambi√©n para importar el resto de librer√≠as que vamos a ir necesitando:
```py
import matplotlib.pyplot as plt
import numpy as np
import pandas as pd
from PIL import Image
```

Seguidamente escribiremos la funci√≥n **main** y en ella configuraremos algunos par√°metros de la aplicaci√≥n como el **t√≠tulo**, el **icono**, el tipo de **layout** y la configuraci√≥n inicial de la **barra lateral**.
```py
st.set_page_config(
        page_title=f"Reconocimiento de d√≠gitos",
        page_icon="üëÅÔ∏è", 
        layout="centered",
        initial_sidebar_state="auto",
    )
```

**Streamlit** nos permite ir viendo el progreso de la aplicaci√≥n en un servidor local de forma sencilla. Para ello simplemente debemos escribir lo siguiente en nuestra terminal:
```sh
$ streamlit run Aplicacion.py
```

Cada vez que avancemos en el c√≥digo y guardemos, streamlit actualizar√° la visualizaci√≥n.

Un detalle muy importante que debemos tener en cuenta siempre que dise√±emos una aplicaci√≥n con **Streamlit** es que **en cada interacci√≥n del usuario con cualquier elemento de la aplicaci√≥n**, los scripts se ejecutar√°n de arriba a abajo siempre. Esto es fundamental tenerlo claro cuando implementemos nuestra l√≥gica, sobre todo a la hora de asignar variables. No te preocupes, **Streamlit** pone a disposici√≥n de los desarrolladores unas variables de sesi√≥n que veremos m√°s adelante.

Deber√≠a mostrarse una [barra lateral](https://docs.streamlit.io/library/api-reference/layout/st.sidebar) con unas opciones seleccionables: **Aplicacion** y **Modelo**.

Para agregar m√°s elementos a la barra lateral podemos hacerlo con la notaci√≥n **with**:
```py
with st.sidebar:
    # Todo lo que est√° en el interior
    # del bloque 'with' aparecer√° en la barra lateral.
```

Podemos agregar nuestra firma, una imagen o lo que nos plazca. **Streamlit** tiene varias posibilidades de [escritura](https://docs.streamlit.io/library/api-reference/text):
- **st.markdown()** : permite agregar notaci√≥n **markdown** y HTML si pasamos el argumento **unsafe_allow_html**.
- **st.title()**
- **st.header()**
- **st.subheader()**
- **st.caption()** : escribe texto en letra peque√±a.
- **st.code()** : escribe un bloque de c√≥digo.
- **st.text()** : escribe texto plano.
- **st.latex()** : escribe texto formateado para expresiones matem√°ticas.

Podemos cargar una imagen de la misma manera, con la funci√≥n **st.image()** y especificando la ruta del archivo.

Una vez hayamos terminado con el t√≠tulo y la descripci√≥n de la aplicaci√≥n, incorporaremos las diferentes pesta√±as tal y como hemos descrito en el apartado **Descripci√≥n de la app.**

Para agregar una [pesta√±a](https://docs.streamlit.io/library/api-reference/layout/st.tabs), se sigue una l√≥gica similar a la de la barra lateral. La funci√≥n **st.tabs()** requiere de una lista como argumento que representa el nombre de las etiquetas de las pesta√±as. La funci√≥n devuelve una tupla de igual longitud que la lista de nombres pasados.
```py
# Definimos las 5 tabs que tendr√° nuestra app
tab_cargar_imagen, tab_ver_digito, tab_predecir, \
    tab_evaluar, tab_estadisticas = st.tabs(['Cargar imagen', 'Ver d√≠gito', 
                                    'Predecir', 'Evaluar', 'Ver estad√≠sticas'])
```

Los objetos devueltos por la funci√≥n **st.tabs()** pueden usarse con la notaci√≥n **with** para incorporar elementos dentro de cada pesta√±a:
```py
with tab_cargar_imagen:
    st.write('''Carga tu imagen con el d√≠gito dibujado. 
        Recuerda que debe ser una imagen de 28x28 p√≠xeles.<br>El d√≠gito debe estar
        dibujado en blanco sobre color negro.''', unsafe_allow_html=True)
```
#### Pesta√±a Cargar imagen.
En esta primera pesta√±a vamos a dar la posibilidad al usuario de cargar una imagen. Realizaremos las siguientes etapas:
- Guardar la imagen del usuario en una variable
- Transformar la imagen en un array de **numpy**
- Verificar que la imagen cumpla los par√°metros requeridos para pasarla por nuestro modelo
- Guardamos el nombre del archivo en sesi√≥n y mostramos mensaje de √©xito

Para poder guardar el contenido de un archivo en una variable, streamlit pone a nuestra disposici√≥n la funci√≥n **st.file_uploader()**. Al llamar a esta funci√≥n, streamlit mostrar√° el widget de carga de archivos en la web.
```py
imagen_bruta = st.file_uploader(label='Sube tu d√≠gito', type=["png","tif","jpg","bmp","jpeg"], on_change=reset_predictions)
```

Esta funci√≥n nos devuelve o **None** si no hay ninguna imagen o un objeto de **UploadedFile**. El resto de l√≥gica dentro de esta pesta√±a solo deber√° ejecutarse **si** el usuario ha cargado una imagen. Recuerda que cada interacci√≥n del usuario con la aplicaci√≥n ejecuta todos los scripts de arriba a abajo. A√±adimos un bloque condicional para agrupar el resto del c√≥digo de esta pesta√±a:
```py
if imagen_bruta is not None:
    # TODO: Transformar en array
    # TODO: Validar la imagen
    # TODO: Si no es v√°lida detener la ejecuci√≥n de la aplicaci√≥n
    # TODO: Guardar nombre del archivo en sesi√≥n
    # TODO: Mostrar mensaje de √©xito.
```

Para transformar los datos de la imagen en un array primero tenemos que leer el contenido del objeto **UploadedFile** que nos lo devolver√° en bytes. La librer√≠a [Pillow](https://pillow.readthedocs.io/en/stable/reference/Image.html) es muy utilizada en Python para el tratamiento de im√°genes y el m√©todo **open** dentro del m√≥dulo **Image** nos permite abrir la imagen pero antes es necesario envolver los bytes devueltos por el objeto UploadedFile con la clase **BytesIO** para tratar dichos bytes como si de un archivo se trataran. El c√≥digo queda as√≠:
```py
img_array = np.array(Image.open(BytesIO(imagen_bruta.read())))
```

**BytesIO** se importa de la librer√≠a **io** que viene incluida con Python.

Si la imagen cargada por el usuario no pasa nuestras funciones de validaci√≥n, es apropiado mostrar un mensaje de error al usuario y detener la aplicaci√≥n, de lo contrario podr√≠amos encontrarnos con m√∫ltiples errores.
```py
if not valid_img:
                st.error(error_msg)
                st.stop() # Lo que viene despu√©s del stop no se ejecutar√°.
```

**Streamlit** tambi√©n permite volver a ejecutar la aplicaci√≥n con la funci√≥n **st.rerun()**.

Para poder guardar informaci√≥n de manera persistente y que sobreviva a las interacciones del usuario con la aplicaci√≥n, streamlit pone a nuestra disposici√≥n [**st.session_state**](https://docs.streamlit.io/library/api-reference/session-state).

**st.session_state** es un diccionario (un objeto diccionario cl√°sico de Python) de sesi√≥n en el que podemos escribir y extraer la informaci√≥n que queramos. Este diccionario no se reescribe cada vez que se ejecuta el c√≥digo pero s√≠ se reinicia cuando volvemos a cargar la sesi√≥n (cuando volvemos a cargar la aplicaci√≥n). Si quisi√©ramos que la informaci√≥n fuera persistente entre sesiones tendr√≠amos que almacenarla en una base de datos. Para nuestra aplicaci√≥n de hoy, st.session_state ser√° suficiente.

Suele ser de gran ayuda tambi√©n mostrar el contenido de st.session_state a medida que se desarrolla la aplicaci√≥n. Para ello puedes escribir lo siguiente al principio o final de tu script:
```py
st.session_state
```

En nuestro caso guardaremos el nombre del archivo con la clave *imagen_cargada_y_validada*.
```py
# Si la imagen es v√°lida guardamos en sesi√≥n el nombre del archivo y mostramos un mensaje de √©xito
st.session_state['imagen_cargada_y_validada'] = imagen_bruta.name
# Este mensaje solo se mostrar√° si hay una imagen cargada y si la imagen est√° validada
st.success('Imagen cargada correctamente.')
```

**Streamlit** permite usar 4 tipos de [mensaje de estado](https://docs.streamlit.io/library/api-reference/status):
- **st.error()** : muestra el mensaje sobre fondo rojo.
- **st.warning()** : muestra el mensaje sobre fondo amarillo.
- **st.info()** : muestra el mensaje sobre fondo azul.
- **st.success()** : muestra el mensaje sobre fondo verde.

Todos ellos tienen la posibilidad de incluir un icono en el mensaje.

#### Pesta√±a Ver d√≠gito.
Una vez terminada la implementaci√≥n de la primera pesta√±a podemos pasar a la segunda. En esta pesta√±a simplemente mostraremos la imagen cargada por el usuario para poder visualizar el d√≠gito.

**Streamlit** incorpora funciones propias para visualizar varios tipos de [gr√°ficos](https://docs.streamlit.io/library/api-reference/charts) y adem√°s tambi√©n ofrece la posibilidad de visualizar gr√°ficos realizados con **matplotlib**. Los gr√°ficos propios de streamlit son interactivos mientras que aquellos realizados con librer√≠as como matplotlib se visualizan como im√°genes.

Mostraremos el d√≠gito del usuario con el siguiente c√≥digo:
```py
with tab_ver_digito:
    # Verificamos que tengamos una imagen cargada y validada en sesi√≥n
    if nombre_archivo:=st.session_state.get('imagen_cargada_y_validada'):
        fig, ax = plt.subplots(figsize=(5, 2))
        ax.imshow(img_array, cmap="gray")
        ax.axis('off')
        ax.set_title(nombre_archivo, fontsize=5)
        st.pyplot(fig)
    else:
        st.info('Carga una imagen para visualizar.')
```

De nuevo, es importante tener en cuenta que cada interacci√≥n del usuario con los elementos de la aplicaci√≥n har√° que se ejecute todo el c√≥digo. Por ello, para evitar errores, verificamos primero que exista una imagen cargada y haya sido validada. Comprobamos si en sesi√≥n existe el campo **imagen_cargada_y_validada** que hemos guardado previamente en la pesta√±a anterior tras realizar las validaciones. De ser as√≠, mostramos el gr√°fico.

Para visualizar un gr√°fico de matplotlib en streamlit basta con pasarle el objeto **Figure** devuelto por **subplots** a la funci√≥n **st.pyplot()**.

![Alt text](img/ver_digito_2.JPG)

#### Pesta√±a Predecir.

#### Pesta√±a Evaluar.

#### Pesta√±a Estad√≠sticas.











